{{#
    @name Map
    @desc The Map page builder block.
    @set page.page_builder.map
#}}

<!-- /page_builder/_map.antlers.html -->
<section class="grid gap-8 fluid-container md:grid-cols-12">
    <iframe src="https://www.google.com/maps/d/embed?mid=1wTbhd56G7zWCasF0ybPQRWC2rXQvLsg&ehbc=2E312F" width="640"
        height="480"></iframe>

</section>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />



{{# templates/default.antlers.html or similar #}}
<div x-data="kmlMap()" x-init="initMap()" class="space-y-4">
    <!-- Map container -->
    <div id="map" class="w-full rounded-lg shadow-lg h-96"></div>

    <!-- Loading indicator -->
    <div x-show="loading" class="py-4 text-center">
        <div class="inline-block w-8 h-8 border-b-2 border-blue-500 rounded-full animate-spin"></div>
        <p class="mt-2 text-gray-600">Loading map data...</p>
    </div>

    <!-- Error message -->
    <div x-show="error" class="p-4 border border-red-200 rounded-lg bg-red-50">
        <p class="text-red-600" x-text="error"></p>
    </div>

    <!-- Location cards -->
    <div x-show="!loading && locations.length > 0" class="grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3">
        <template x-for="location in locations" :key="location.id">
            <div class="p-4 transition-shadow bg-white border border-gray-200 rounded-lg shadow cursor-pointer hover:shadow-xl"
                @click="focusOnLocation(location)">
                <h3 class="text-lg font-semibold text-gray-900" x-text="location.name"></h3>
                <p class="mt-1 text-sm text-gray-600" x-text="location.description"></p>
            </div>
        </template>
    </div>
</div>

<script>
    function kmlMap() {
        return {
            map: null,
            kmlLayer: null,
            locations: [],
            loading: true,
            error: null,

            initMap() {
                // Check if Leaflet is loaded
                if (typeof L === 'undefined') {
                    this.error = 'Leaflet library not loaded. Please check your scripts.';
                    this.loading = false;
                    return;
                }

                // Initialize map - centered on New Zealand
                this.map = L.map('map').setView([-41.2865, 174.7762], 5);

                // Add OpenStreetMap tiles
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(this.map);

                // Load KML
                this.loadKML();
            },

            loadKML() {
                // Check if Omnivore is loaded
                if (typeof omnivore === 'undefined') {
                    this.error = 'Leaflet Omnivore not loaded. Check scripts.';
                    this.loading = false;
                    return;
                }

                this.kmlLayer = omnivore.kml('/files/nz_map.kml')
                    .on('ready', () => {
                        this.loading = false;

                        // Zoom to fit all markers
                        if (this.kmlLayer.getBounds().isValid()) {
                            this.map.fitBounds(this.kmlLayer.getBounds());
                        }

                        // Extract locations
                        this.extractLocations();
                    })
                    .on('error', (e) => {
                        this.loading = false;
                        this.error = 'Could not load KML file. Check the file path: /files/nz_map.kml';
                        console.error('KML Error:', e);
                    })
                    .addTo(this.map);
            },

            extractLocations() {
                this.locations = [];

                this.kmlLayer.eachLayer((layer) => {
                    if (layer.feature && layer.feature.properties) {
                        const props = layer.feature.properties;

                        this.locations.push({
                            id: this.locations.length,
                            name: props.name || 'Unnamed Location',
                            description: props.description || 'No description available',
                            layer: layer
                        });

                        // Add popup to marker
                        layer.bindPopup(`
              <div class="p-3 min-w-[200px]">
                <h3 class="mb-2 text-lg font-bold">${props.name || 'Location'}</h3>
                <p class="text-sm text-gray-700">${props.description || ''}</p>
              </div>
            `);
                    }
                });

                console.log(`Loaded ${this.locations.length} locations`);
            },

            focusOnLocation(location) {
                // Get coordinates and zoom to location
                const latLng = location.layer.getLatLng();
                this.map.setView(latLng, 15);

                // Open popup
                location.layer.openPopup();
            }
        }
    }
</script>




<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-omnivore@0.3.4/leaflet-omnivore.min.js"></script>


<!-- End: /page_builder/_map.antlers.html -->